@page
@using System.Text.Json
@using System.Text.Json.Serialization
@model PRN211GroupProject.Pages.Accounts.Booking.PaymentModel
@{
    Layout = null;
    var roundedDiscount = Math.Round(Model.Discount, 2).ToString("0.00");
    var total = Model.Sum - Model.Discount;
}
<!doctype html>
<html>
<head>
    <meta charset='utf-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <title>Payment</title>
    <link href='https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css' rel='stylesheet'>
    <link href='https://use.fontawesome.com/releases/v5.7.2/css/all.css' rel='stylesheet'>
    <script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js'></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        ::-webkit-scrollbar {
            width: 8px;
        }
        /* Track */
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        /* Handle */
        ::-webkit-scrollbar-thumb {
            background: #888;
        }

            /* Handle on hover */
            ::-webkit-scrollbar-thumb:hover {
                background: #555;
            }
    </style>
    <script>
        $(document).ready(function () {
            // Submit form using AJAX
            $('#paymentForm').submit(function (e) {
                e.preventDefault(); // Prevent default form submission

                // Serialize form data
                var formData = $(this).serialize();

                // Send AJAX request
                $.ajax({
                    url: '/Accounts/Booking/Payment?handler=Bill', // Specify your Razor Page handler
                    type: 'POST',
                    data: formData,
                    success: function (response) {
                        if (response.success) {
                            // Show success message using SweetAlert
                            Swal.fire({
                                icon: 'success',
                                title: 'Payment Successful!',
                                showConfirmButton: false,
                                timer: 1500
                            });

                            // Optionally, redirect after success
                            window.location.href = '/index';
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'Oops...',
                                text: 'Something went wrong!',
                                footer: '<a href="#">Contact support</a>'
                            });
                        }
                    },
                    error: function () {
                        Swal.fire({
                            icon: 'error',
                            title: 'Oops...',
                            text: 'Something went wrong!',
                            footer: '<a href="#">Contact support</a>'
                        });
                    }
                });
            });
        });
    </script>


    <link rel="stylesheet" href="~/css/payment.css" />
</head>
<body className='snippet-body'>
    <div class="container mt-4 p-0">
        <nav class="navbar navbar-expand-lg navbar-light bg-white pt-3 px-md-4 px-2">
            <div class="container-fluid">
                <a class="navbar-brand" href="/Accounts/Booking/">
                    <span class="fas fa-arrow-alt-circle-left"></span> Back
                </a> <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#nav" aria-controls="nav" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button>
                <div class="collapse navbar-collapse" id="nav">
                    <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    </ul>
                    <ul class="d-flex mb-0">
                        <li class="nav-item pe-3">
                            <div class="d-flex align-items-center">
                                <div>
                                    <p class="">@User.Identity.Name</p>
                                </div>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>
        <div class="row px-md-4 px-2 pt-4">
            <div class="col-lg-8">
                <p class="pb-2 fw-bold">Order</p>
                <div class="card">
                    <div>
                        <div class="table-responsive px-md-4 px-2 pt-3">
                            <table class="table table-borderless">
                                <tbody>
                                    @if (Model.BillDetaileds != null && Model.BillDetaileds.Count > 0)
                                    {
                                        @for (int i = 1; i <= Model.BillDetaileds.Count; i++)
                                        {
                                            <tr class="border-bottom">
                                                <td>
                                                    <div class="d-flex align-items-center">
                                                        <div class="round"> <span class=""> @i</span> </div>
                                                    </div>
                                                </td>
                                                <td>
                                                    <div class="d-flex align-items-center">
                                                        <div class="ps-3 d-flex flex-column justify-content">
                                                            <p class="fw-bold">@Model.BillDetaileds[i - 1].Booking.Available.Service.Name</p> <small class=" d-flex"><span class=" fw-bold">@Model.BillDetaileds[i - 1].Booking.Available.Spot.Name</span> </small> <small class=""> <span class=" text-muted">Date:</span> <span class=" fw-bold">@Model.BillDetaileds[i - 1].Booking.Started</span> </small>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td>
                                                    <div class="d-flex">
                                                        <p class="pe-3"><span class="red">$@Model.BillDetaileds[i - 1].Cost</span></p>
                                                    </div>
                                                </td>
                                                <td>
                                                    <div class="d-flex align-items-center">
                                                        <span class="pe-3 text-muted">Duration @Model.BillDetaileds[i - 1].Booking.Available.Service.Duration minutes</span>
                                                    </div>
                                                </td>
                                            </tr>
                                        }
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-4 payment-summary">
                <p class="fw-bold pt-lg-0 pt-4 pb-2">Payment Summary</p>
                <div class="card px-md-3 px-2 pt-4">
                    <div class="unregistered mb-4"> <span class="py-1">User Information</span> </div>
                    <div class="d-flex justify-content-between pb-3">
                        <small class="text-muted">Email</small>
                        <p class="">@Model.Account.Email</p>
                    </div>
                    <div class="d-flex justify-content-between pb-3">
                        <small class="text-muted">Name</small>
                        <p class="">@Model.Account.Name</p>
                    </div>
                    <div class="d-flex justify-content-between pb-3">
                        <small class="text-muted">Phone Number</small>
                        <p class="">@Model.Account.Phone</p>
                    </div>
                    <div class="d-flex justify-content-between pb-3">
                        <form method="post" asp-page-handler="ApplyVoucher">
                            <div class="d-flex justify-content-between b-bottom">
                                <select class="form-select ps-2" asp-for="SelectedVoucherId">
                                    @if (Model.Account.Voucher != null)
                                    {
                                        <option value="0">Select Voucher</option>
                                        <option value="@Model.Account.VoucherId">@Model.Account.Voucher.Name (Expires: @Model.Account.Voucher.Expired.ToString("yyyy-MM-dd"))</option>
                                        <input type="hidden" value="@Model.Discount" asp-for="Discount" />
                                        <input type="hidden" value="@Model.Sum" asp-for="Sum" />
                                    }
                                    else
                                    {
                                        <option value="0">No vouchers available</option>
                                    }
                                </select>
                                <button type="submit" class="btn btn-primary">
                                    Apply
                                </button>
                            </div>
                        </form>
                    </div>


                    <div class="d-flex flex-column b-bottom">
                        <div class="d-flex justify-content-between py-3">
                            <small class="text-muted">Order Summary</small>
                            <p class="text-muted text-decoration-line-through">$@Model.Sum</p>
                        </div>
                        <div class="d-flex justify-content-between pb-3">
                            <small class="text-muted">Discount</small>
                            <p>- $@roundedDiscount</p>
                        </div>
                        <div class="d-flex justify-content-between">
                            <small class="fw-bold">Total Amount</small>
                            <p class="fw-bold">@total.ToString("0.00")</p>
                        </div>
                    </div>
                    </br>
                    @{
                        JsonSerializerOptions options = new JsonSerializerOptions
            {
                ReferenceHandler = ReferenceHandler.Preserve,
                WriteIndented = true
            };
                        string billDetailedJson = JsonSerializer.Serialize(Model.BillDetaileds, options);
                    }
                    <form method="post" asp-page-handler="Bill">
                        <input type="hidden" value="@roundedDiscount" asp-for="Discount" />
                        <input type="hidden" value="@Model.Sum" asp-for="Sum" />
                        <input type="hidden" value="@billDetailedJson" id="billDetailedJson" name="billDetailedJson" />
                        <input type="hidden" value="@Model.SelectedVoucherId" asp-for="SelectedVoucherId" />
                        <div class="d-flex justify-content-between pb-3">
                            <small class="text-muted"></small>
                            <button type="submit"
                                    class="btn btn-success"
                                    id="alert_demo_3_3">
                                Submit
                            </button>

                        </div>
                    </form>
                </div>
            </div>
        </div>
        <script src="~/adminAssets/assets/js/plugin/sweetalert/sweetalert.min.js"></script>

        <script type='text/javascript' src='https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.bundle.min.js'></script>
        <script type='text/javascript' src='#'></script>
        <script type='text/javascript' src='#'></script>
        <script type='text/javascript' src='#'></script>
        <script type='text/javascript'>#</script>
        <script type='text/javascript'>
            var myLink = document.querySelector('a[href="#"]');
            myLink.addEventListener('click', function (e) {
                e.preventDefault();
            });</script>
        <script>
            //== Class definition
            var SweetAlert2Demo = (function () {
                //== Demos
                var initDemos = function () {
                    $("#alert_demo_3_3").click(function (e) {
                        swal("Payment Success!", "Thankyou for use our service!", {
                            icon: "success",
                            buttons: {
                                confirm: {
                                    className: "btn btn-success",
                                },
                            },
                        });
                    });
                };

                return {
                    //== Init
                    init: function () {
                        initDemos();
                    },
                };
            })();

            //== Class Initialization
            jQuery(document).ready(function () {
                SweetAlert2Demo.init();
            });
        </script>
</body>
</html>